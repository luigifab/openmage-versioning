/*!
 * Copyright 2011-2021 | Fabrice Creuzot (luigifab) <code~luigifab~fr>
 * https://www.luigifab.fr/openmage/versioning
 * This program is free software, you can redistribute it or modify
 * it under the terms of the GNU General Public License (GPL).
 */
window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(t,e,o){for(e=e||window,o=0;o<this.length;o++)t.call(e,this[o],o,this)});var versioning=new function(){"use strict";this.svg=null,this.width=197,this.start=function(){document.getElementById("versioning_grid_table")&&document.querySelector("table.data tbody input")?(console.info("versioning.app - hello"),this.drawGraph(self.versioningIds,self.versioningCols).startDiff()):document.getElementById("versioning_history_grid_table")&&document.querySelector("table.data tbody button")&&(console.info("versioning.app - hello"),document.querySelector("table.data tbody button").click())},this.loader=function(){document.querySelector("body").classList.add("progress")},this.decode=function(t){return decodeURIComponent(escape(self.atob(t)))},this.confirmFlag=function(e,t,o){try{return apijs.dialog.dialogConfirmation(t,this.decode(o),versioning.actionConfirmFlag,e,"versioning "+document.getElementById("scmtype").textContent),!1}catch(t){console.error(t);try{apijs.dialog.actionClose()}catch(t){}try{return!!confirm(this.decode(o).replace(/\[[^\]]+]/g,""))&&(this.loader(),self.location.href=e,!0)}catch(t){return console.error(t),!!confirm(Translator.translate("Are you sure?"))&&(this.loader(),self.location.href=e,!0)}}},this.actionConfirmFlag=function(t){versioning.loader(),apijs.dialog.remove("waiting","lock"),self.location.href=t},this.cancelFlag=function(t){this.loader(),self.location.href=t},this.confirmUpgrade=function(e,o){try{return e.match(/revision\/(\w+)\//),apijs.dialog.dialogFormOptions(o.replace("ยง",RegExp.$1),this.decode(self.versioningText),e,versioning.actionConfirmUpgrade,null,"versioning "+document.getElementById("scmtype").textContent),!1}catch(t){console.error(t);try{apijs.dialog.actionClose()}catch(t){}try{var r=document.createElement("div"),n=this.decode(self.versioningText).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[/g,"<").replace(/]/g,">"),i=document.getElementById("scmtype").textContent;return e.match(/revision\/(\w+)\//),r.innerHTML='<div class="fake options versioning '+i+' ready" id="apijsDialog"><form method="get" action="'+e+'" class="fake options versioning '+i+' ready" onsubmit="return versioning.actionConfirmUpgrade(true);" id="apijsBox"><h1>'+o.replace("ยง",RegExp.$1)+'</h1><div class="bbcode">'+n+'</div><div class="control"><button type="submit" class="confirm">Valider</button><button type="button" class="cancel" onclick="versioning.closeConfirmUpgrade();">Annuler</button></div></form></div>',document.querySelector("body").appendChild(r),document.querySelector("div.bbcode input").focus(),!1}catch(t){return console.error(t),!!confirm(Translator.translate("Are you sure?"))&&(this.loader(),!0)}}},this.closeConfirmUpgrade=function(){document.getElementById("apijsDialog").remove()},this.actionConfirmUpgrade=function(t){return!1===t||(versioning.loader(),!0===t?(document.querySelector("div.bbcode").setAttribute("style","visibility:hidden;"),document.querySelector("div.control").setAttribute("style","visibility:hidden;")):(apijs.dialog.remove("waiting","lock"),self.location.href=t+apijs.serialize(document.getElementById("apijsBox")).replace(/[=&]/g,"/"))),!0},this.history=function(t,e){return document.querySelectorAll("table.data tbody tr[class]").forEach(function(t){t.classList.remove("current")}),document.querySelector("pre").innerHTML=this.decode(e)+"\n\n",t.parentNode.parentNode.classList.add("current"),!1},this.drawGraph=function(r,t){var n,i,s,a,l,c="",e=Object.keys(r).map(function(t){return r[t]}),d=$$("table.data tbody tr"),u=d.length-1,o=[],h=[],g=[],p=[],f=[],m=0,v=0,y=0,b=0,k=0,w=0;for(e.sort(function(t,e){return t.row>e.row?-1:t.row<e.row?1:0}),y="function"==typeof Element.Layout?(v=d.first().getLayout().get("top")-1,d.last().getLayout().get("top")+d.last().getLayout().get("height")-v-1):(v=Element.positionedOffset(d.first())[1]-1,Element.positionedOffset(d.last())[1]+d.last().getDimensions().height-v-1),this.svg=new Raphael(document.getElementById("versioning_grid_table").parentNode),this.svg.setSize(this.width,y),this.svg.canvas.setAttribute("style","top:"+v+"px;"),this.svg.canvas.setAttribute("class","k k0"),this.svg.canvas.setAttribute("id","versioning_graph"),this.svg.canvas.setAttribute("onmouseover","versioning.mouseOver(true);"),this.svg.canvas.parentNode.setAttribute("onmouseleave","versioning.mouseOver(false);"),Raphael.getColor.reset(),Raphael.getColor(),o.push(Raphael.getColor()),n=0;n<=t;n++)Raphael.getColor(),Raphael.getColor(),o.push(Raphael.getColor()),h.push("svg.k"+n+" .k:not(.k"+n+") { opacity:0.4; }"),h.push("table.k"+n+" .k:not(.k"+n+") { color:#CCC; }"),h.push("table.k"+n+" .k:not(.k"+n+") button { opacity:0; visibility:hidden; }");return e.forEach(function(t){t.color=o[t.col],t.klass="k k"+t.col,f[t.col]=t.revision,p[t.col]||(p[t.col]=t.revision)}),e.forEach(function(o){k="function"==typeof Element.Layout?(b=d[u-o.row].getLayout().get("top")-v,d[u-o.row].getLayout().get("height")/2):(b=Element.positionedOffset(d[u-o.row])[1]-v,d[u-o.row].getDimensions().height/2),i=b+k,n=25*o.col+20,this.svg.circle(n,i,3.5).attr("fill",o.color).attr("stroke","none").attr("class",o.klass),0<o.branch.length&&g.indexOf(o.branch)<0&&(g.push(o.branch),l=this.svg.text(n+13,i-.3,o.branch).attr("fill",o.color).attr("text-anchor","start").attr("class",o.klass),s=n+3.2+8+l.getBBox().width+7,this.svg.path("M "+(n+3.2)+","+(i-.4)+" L "+(n+3.2+8)+","+(i-.4-8)+" L "+s+","+(i-.4-8)+" L "+s+","+(i-.4+8)+" L "+(n+3.2+8)+","+(i-.4+8)+" Z").attr("stroke",o.color).attr("fill","white").attr("fill-opacity","0.7").attr("stroke-opacity","0.2").attr("class",o.klass).toFront(),l.toFront(),s>this.width&&(this.width=s)),o.parents.forEach(function(t,e){"object"==typeof(e=0<t.length?r[t]:void 0)?(k="function"==typeof Element.Layout?(b=d[u-e.row].getLayout().get("top")-v,d[u-e.row].getLayout().get("height")/2):(b=Element.positionedOffset(d[u-e.row])[1]-v,d[u-e.row].getDimensions().height/2),a=b+k,s=25*e.col+20,e.col===o.col?this.svg.path(["M",n,i,"V",a]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class",o.klass).toBack():(c+='<linearGradient id="manGrad'+m+'" x1="0" y1="0" x2="100%" y2="0"><stop offset="0" stop-color="'+(s<n?e:o).color+'"></stop><stop offset="100%" stop-color="'+(s<n?o:e).color+'"></stop></linearGradient>',w="function"==typeof Element.Layout?d[u-e.row].getLayout().get("height")/2:d[u-e.row].getDimensions().height/2,w+=k,e.revision===p[e.col]&&i+w<a?((l=this.svg.path(["M",n,i,"T",s,i+w])).node.setAttribute("stroke","url(#manGrad"+m+")"),l.attr("stroke-width",1.6).attr("class","k").toBack(),this.svg.path(["M",s,i+w,"V",a]).attr("stroke",e.color).attr("stroke-width",1.7).attr("class","k").toBack()):(o.revision===f[o.col]&&i+w<a&&1===o.parents.length?(this.svg.path(["M",n,i,"V",a-w]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class","k").toBack(),(l=this.svg.path(["M",n,a-w,"T",s,a])).node.setAttribute("stroke","url(#manGrad"+m+")")):(l=this.svg.path(["M",n,i,"T",s,a])).node.setAttribute("stroke","url(#manGrad"+m+")"),l.attr("stroke-width",1.6).attr("class","k").toBack()),m+=1)):0<t.length&&this.svg.path(["M",n,i,"V",y]).attr("stroke",o.color).attr("stroke-width",1.7).attr("class",o.klass).toBack()},this),(l=d[u-o.row]).setAttribute("onclick","versioning.updateClass(this.getAttribute('class'));"),l.setAttribute("class",o.row%2<1?o.klass:"even "+o.klass),l.removeAttribute("title")},this),0<c.length&&(document.querySelector("svg defs").innerSVG=c),(l=document.createElement("style")).setAttribute("type","text/css"),l.setAttribute("id","versioning_styles"),l.appendChild(document.createTextNode(h.join("\n"))),document.querySelector("head").appendChild(l),this},this.mouseOver=function(t){this.svg.canvas.style.width=t?this.width+"px":"197px",this.svg.canvas.style.pointerEvents=t?"none":"inherit"},this.updateClass=function(t){this.svg.canvas.setAttribute("class",t),document.getElementById("versioning_grid_table").setAttribute("class","data "+t)},this.startDiff=function(){var e=1,o=1,r=!0;return document.querySelectorAll('table.data input[type="radio"]').forEach(function(t){t.setAttribute("onchange","versioning.goDiff("+(r?e++:o++)+", "+(r?"false":"true")+");"),t.removeAttribute("disabled"),r=!r}),document.querySelector('table.data tr:last-child input[name="d1"]').setAttribute("disabled","disabled"),document.querySelector('table.data tr:first-child input[name="d2"]').setAttribute("disabled","disabled"),document.querySelector('table.data input[name="d1"]:not([disabled])').checked=!0,document.querySelector('table.data input[name="d2"]:not([disabled])').checked=!0,this.goDiff()},this.goDiff=function(t,e){var o=document.querySelector('table.data input[name="d1"]:checked'),r=document.querySelector('table.data input[name="d2"]:checked'),n=parseInt(o.getAttribute("onchange").replace(/\D/g,""),10),i=parseInt(r.getAttribute("onchange").replace(/\D/g,""),10);return"string"==typeof t?(this.loader(),self.location.href=t):(!0===e?i<=n&&((o=r.parentNode.parentNode.previousElementSibling.querySelector('input[name="d1"]')).checked=!0):i<=n&&((r=o.parentNode.parentNode.nextElementSibling.querySelector('input[name="d2"]')).checked=!0),n=(n=(n=document.querySelector("div.content-header td.form-buttons button").getAttribute("onclick")).replace(/\/from\/[^\/]+/,"/from/"+r.value)).replace(/\/to\/[^\/]+/,"/to/"+o.value),document.querySelector("div.content-header td.form-buttons button").setAttribute("onclick",n),document.querySelector("div.content-header-floating td.form-buttons button").setAttribute("onclick",n)),this}};"function"==typeof self.addEventListener&&self.addEventListener("load",versioning.start.bind(versioning));
//# sourceMappingURL=app.min.js.map